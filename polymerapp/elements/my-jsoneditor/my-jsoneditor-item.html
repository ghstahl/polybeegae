<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../bower_components/paper-input/all-imports.html">
<link rel="import" href="../../../bower_components/paper-item/all-imports.html">

<link rel="import" href="../pingo-group/pingo-radio-input.html">
<link rel="import" href="../pingo-group/pingo-toggle-input.html">

<dom-module id="my-jsoneditor-item">

    <style is="custom-style">
        .line {
            margin-bottom: 40px;
        }
        
        .line span {
            margin-left: 24px;
        }
        
        .radioGroup {
            margin-left: 40px;
        }
    </style>
    <template>
        <!-----------------------------------------------------------------
                STRING Input
            -------------------------------------------------------------------->
        <template is="dom-if" if="{{_isSame(item.value.type,'string')}}">
            <paper-input id="{{computedId(item)}}" label={{item.name}} value={{item.value.value}} allowed-pattern={{computeAllowedPattern(item.value)}} required={{item.value.required}} prevent-invalid-input auto-validate error-message="Invalid input!" placeholder="{{placeholder}}"></paper-input>
        </template>
        <!----------------------------------------------------------------- 
                BOOLEAN Input
        -------------------------------------------------------------------->
        <template is="dom-if" if="{{_isSame(item.value.type,'boolean')}}">
            <div class="line">
                <paper-toggle-button checked={{item.value.value}}></paper-toggle-button>
                <span>{{item.name}}</span>
                <span>{{computeBooleanToString(item.value.value)}}</span>
            </div>
        </template>
        <!-----------------------------------------------------------------
                RADIO GROUP Input
        -------------------------------------------------------------------->
        <template is="dom-if" if="{{_isSame(item.value.type,'radio')}}">
            <pingo-radio-input id="{{computedId(item)}}" label={{item.name}} value={{item.value.value}} radio-items={{item.value.radioGroup}}></pingo-radio-input>
        </template>
        <!-----------------------------------------------------------------
                Toggle GROUP Input
            -------------------------------------------------------------------->
        <template is="dom-if" if="{{_isSame(item.value.type,'toggleGroup')}}">
            <pingo-toggle-input id="{{computedId(item)}}" label={{item.name}} value={{item.value.value}}></pingo-toggle-input>
        </template>

    </template>
    <script>
        (function () {
            Polymer({
                is: 'my-jsoneditor-item',

                // Properties
                /////////////////////////////////////////////////////////
                properties: {
                    item: {
                        type: Object,
                        notify: true,
                        observer: '_newItemObserved',
                    },

                    // Read-Only Properties
                    /////////////////////////////////////////////////////////
                    _item_immutable: {
                        type: Object,
                        readOnly: true
                    },

                    paperElementTemplates: {
                        type: Object,
                        notify: true

                    },

                    _item_dirty: {
                        type: Boolean,
                        readOnly: true,
                        value: false
                    },

                    readonly: {
                        type: Boolean,
                        value: true
                    },

                    placeholder: {
                        type: String,
                        notify: true
                    },

                    required: {
                        type: Boolean,
                        notify: true,
                        value: false
                    }
                },
                // Methods
                /////////////////////////////////////////////////////////
                /**
                 * Validates the input element and sets an error style if needed.
                 *
                 * @return {boolean}
                 */
                validate: function () {
                    var valid = true;
                    switch (this.item.value.type) {
                    case "string":
                    case "radio":
                    case "toggleGroup":
                        // need to get the element by $$ because it is dynamicaly added so no hash
                        //https://www.polymer-project.org/1.0/docs/devguide/local-dom.html
                        var id = "#" + this.computedId(this.item);
                        var el = this.$$(id);
                        valid = el.validate();
                        break;
                    default:
                        valid = true;
                    }
                    return valid;

                },
                computedId: function (item) {
                    return "_id" + item.name;
                },
                _newItemObserved: function (newValue, oldValue) {
                    // move out of item to working set.
                    this._set_item_immutable(JSON.parse(JSON.stringify(newValue)));
                    this._set_item_dirty(false);
                    this.placeholder = this.item.value.required ? "required" : null;
                    this.required = this.item.value.required;
                },
                reset: function () {
                    this.item = this._item_immutable;
                },
                // Observers
                /////////////////////////////////////////////////////////
                observers: ['_valueChanged(item.*)'],
                // Smart check. only fire if we change state.
                _valueChanged: function (changeRecord) {
                    var thisElement = this;
                    if (thisElement._isDirtyValidation() && this._item_dirty === false) {
                        this._set_item_dirty(true);
                        this.fire('item-dirty', {
                            dirty: thisElement._item_dirty,
                            source: thisElement
                        });
                    } else if (!thisElement._isDirtyValidation() && this._item_dirty === true) {
                        this._set_item_dirty(false);
                        this.fire('item-dirty', {
                            dirty: thisElement._item_dirty,
                            source: thisElement
                        });
                    }
                },
                // Utility Methods
                /////////////////////////////////////////////////////////
                _isDirtyValidation: function () {
                    var dirty = this._item_immutable.value.value !== this.item.value.value;
                    return dirty;
                },
                _isSame: function (a, b) {
                    return a === b
                },
                computeBooleanToString: function (a) {
                    return a === true ? 'true' : 'false';
                },
                computeAllowedPattern: function (a) {
                    var allowed = this.paperElementTemplates.paperInput[a.template].allowedPattern
                    return allowed;
                },
                _toArray: function (obj) {
                    var index = 0;
                    var thisElement = this;
                    this._arrayData = Object.keys(obj).map(function (key) {
                        var id = "item_" + index;
                        ++index;
                        var val = obj[key];
                        val.id = id;
                        return {
                            name: key,
                            value: val
                        };
                    });
                    return this._arrayData;
                },
                ready: function () {
                    console.log("my-jsoneditor-item ready");
                }
            });
        })();
    </script>

</dom-module>