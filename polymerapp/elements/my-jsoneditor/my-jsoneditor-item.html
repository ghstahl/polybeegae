<link rel="import" href="../../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../../bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/paper-item/all-imports.html">
<link rel="import" href="../../../bower_components/mat-divider/mat-divider.html">
<link rel="import" href="../pingo-group/pingo-group.html">





<dom-module id="my-jsoneditor-item">

    <style is="custom-style">
        .line {
            margin-bottom: 40px;
        }
        
        .line span {
            margin-left: 24px;
        }
        
        paper-radio-button {
            display: block;
        }
        
        .radioGroup {
            margin-left: 40px;
        }
    </style>
    <template>

        <template is="dom-if" if="{{_isSame(item.value.type,'string')}}">
            <paper-input id="{{computedId(item)}}" label={{item.name}} value={{item.value.value}} allowed-pattern={{computeAllowedPattern(item.value)}} required={{item.value.required}} prevent-invalid-input auto-validate error-message="Invalid input!" placeholder="{{placeholder}}"></paper-input>
        </template>

        <template is="dom-if" if="{{_isSame(item.value.type,'boolean')}}">
            <div class="line">
                <paper-toggle-button checked={{item.value.value}}></paper-toggle-button>
                <span>{{item.name}}</span>
                <span>{{computeBooleanToString(item.value.value)}}</span>
            </div>
        </template>

        <template is="dom-if" if="{{_isSame(item.value.type,'radio')}}">

            <pingo-group title={{item.name}} indent>
                <paper-radio-group selected={{item.value.value}}>

                    <template is="dom-repeat" items="{{_toArray(item.value.radioGroup)}}" as="radioItem">
                        <paper-radio-button name={{radioItem.name}}>{{radioItem.value}}</paper-radio-button>
                    </template>
                </paper-radio-group>
            </pingo-group>

        </template>

    </template>
    <script>
        (function () {
            Polymer({
                is: 'my-jsoneditor-item',

                // Properties
                /////////////////////////////////////////////////////////
                properties: {
                    item: {
                        type: Object,
                        notify: true,
                        observer: '_newItemObserved',
                    },

                    // Read-Only Properties
                    /////////////////////////////////////////////////////////
                    _item_immutable: {
                        type: Object,
                        readOnly: true
                    },
                    paperElementTemplates: {
                        type: Object,
                        notify: true

                    },
                    _item_dirty: {
                        type: Boolean,
                        readOnly: true,
                        value: false
                    },
                    readonly: {
                        type: Boolean,
                        value: true
                    },
                    placeholder: {
                        type: String,
                        notify: true
                    },
                    required: {
                        type: Boolean,
                        notify: true,
                        value: false
                    }
                },
                // Methods
                /////////////////////////////////////////////////////////
                /**
                 * Validates the input element and sets an error style if needed.
                 *
                 * @return {boolean}
                 */
                validate: function () {
                    switch (this.item.value.type) {
                    case "string":
                        // need to get the element by $$ because it is dynamicaly added so no hash
                        //https://www.polymer-project.org/1.0/docs/devguide/local-dom.html
                        var id = "#" + this.computedId(this.item);
                        var el = this.$$(id);
                        return el.validate();
                        break;
                    default:
                        return true;
                    }
                },
                computedId: function (item) {
                    return "_id" + item.name;
                },
                _newItemObserved: function (newValue, oldValue) {
                    // move out of item to working set.
                    this._set_item_immutable(JSON.parse(JSON.stringify(newValue)));
                    this._set_item_dirty(false);
                    this.placeholder = this.item.value.required ? "required" : null;
                    this.required = this.item.value.required;
                },
                reset: function () {
                    this.item = this._item_immutable;
                },
                // Observers
                /////////////////////////////////////////////////////////
                observers: ['_valueChanged(item.*)'],
                // Smart check. only fire if we change state.
                _valueChanged: function (changeRecord) {
                    var thisElement = this;
                    if (thisElement._isDirtyValidation() && this._item_dirty === false) {
                        this._set_item_dirty(true);
                        this.fire('item-dirty', {
                            dirty: thisElement._item_dirty,
                            source: thisElement
                        });
                    } else if (!thisElement._isDirtyValidation() && this._item_dirty === true) {
                        this._set_item_dirty(false);
                        this.fire('item-dirty', {
                            dirty: thisElement._item_dirty,
                            source: thisElement
                        });
                    }
                },
                // Utility Methods
                /////////////////////////////////////////////////////////
                _isDirtyValidation: function () {
                    var dirty = this._item_immutable.value.value !== this.item.value.value;
                    return dirty;
                },
                _isSame: function (a, b) {
                    return a === b
                },
                computeBooleanToString: function (a) {
                    return a === true ? 'true' : 'false';
                },
                computeAllowedPattern: function (a) {
                    var allowed = this.paperElementTemplates.paperInput[a.template].allowedPattern
                    return allowed;
                },
                _toArray: function (obj) {
                    var index = 0;
                    var thisElement = this;
                    this._arrayData = Object.keys(obj).map(function (key) {
                        var id = "item_" + index;
                        ++index;
                        var val = obj[key];
                        val.id = id;
                        return {
                            name: key,
                            value: val
                        };
                    });
                    return this._arrayData;
                },
                _computeUnderlineClass: function (focused, invalid) {
                    var cls = 'underline';
                    if (invalid) {
                        cls += ' is-invalid';
                    } else if (focused) {
                        cls += ' is-highlighted'
                    }
                    return cls;
                },
                ready: function () {
                    console.log("my-jsoneditor-item ready");
                }
            });
        })();
    </script>

</dom-module>