<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/x-json/src/x-json.html">
<link rel="import" href="../../../bower_components/mat-raised-button/mat-raised-button.html">
<link rel="import" href="./my-jsoneditor-item.html">

<dom-module id="my-jsoneditor">

    <style>

    </style>
    <template>
        <paper-material>
            <h1 class="paper-font-display1"><span>{{jsonEditorData.schema.title}}</span></h1>
            <template id="_my_jsonEditor" is="dom-repeat" items="{{_toArray(jsonEditorData.schema.properties)}}">
                <my-jsoneditor-item id={{item.value.id}} item={{item}}></my-jsoneditor-item>
            </template>
            <mat-raised-button disabled={{_isClean}} label="Click me!" on-click="handleClick"></mat-raised-button>
            <mat-raised-button disabled={{_isClean}} label="Reset!" on-click="handleResetClick"></mat-raised-button>
        </paper-material>

        <paper-material elevation="1">
            <x-json id="myjson" data={{jsonEditorData.value.schema.properties}}></x-json>
        </paper-material>
    </template>
    <script>
        (function () {
            Polymer({
                is: 'my-jsoneditor',
                properties: {
                    _isClean: {
                        type: Boolean,
                        readOnly: true,
                        notify: true,
                        value: true
                    },
                    _arrayData: {
                        type: Array
                    },
                    _dirtyItems: {
                        type: Object,
                        notify: false,
                        value: {}
                    },


                    _immutableJsonEditorData: {
                        type: Object,
                        readOnly: true
                    },
                    jsonEditorData: {
                        type: Object,
                        observer: '_newItemObserved',
                        value: {
                            schema: {

                                type: "object",
                                title: "Plant",
                                properties: {
                                    Name: {
                                        type: "string",
                                        value: ""
                                    },
                                    ImageUrl: {
                                        type: "string",
                                        value: ""
                                    },
                                    Enabled: {
                                        type: "boolean",
                                        value: true
                                    }
                                }
                            }
                        }
                    }

                },
                // Methods
                /////////////////////////////////////////////////////////
                _newItemObserved: function (newValue, oldValue) {
                    this._set_immutableJsonEditorData(JSON.parse(JSON.stringify(newValue)));
                },
                _dirtyEventEvaluator: function (e) {
                    e.stopImmediatePropagation();
                    this._dirtyItems[e.detail.source.id] = e.detail.dirty;
                    for (var dirtyItem in this._dirtyItems) {
                        console.log("dirty item:" + dirtyItem + ":" + this._dirtyItems[dirtyItem]);
                    }

                    this._evaluateIsClean();
                    console.log("dirty count:" + this._dirtyCount)
                    console.log("dirty _isClean:" + this._isClean)
                },
                _evaluateIsClean: function () {
                    var dirty = false;
                    for (var dirtyItem in this._dirtyItems) {
                        if (this._dirtyItems[dirtyItem]) {
                            dirty = true;
                            break;
                        }
                    }
                    this._set_isClean(!dirty);
                },

                observers: ['_valueChanged(_arrayData.*)'],
                _valueChanged: function (changeRecord) {
                    console.log('_arrayData changed: ' + changeRecord.path);
                },
                handleClick: function () {
                    this.$.myjson.data = this._arrayData;
                },
                handleResetClick: function () {
                    this._dirtyItems = {};
                    this._set_isClean(true);
                    this.set('jsonEditorData', this._immutableJsonEditorData);
                },
                _toArray: function (obj) {
                    var index = 0;
                    var thisElement = this;
                    this._arrayData = Object.keys(obj).map(function (key) {
                        var id = "item_" + index;
                        ++index;
                        var val = obj[key];
                        val.id = id;
                        return {
                            name: key,
                            value: val
                        };
                    });
                    return this._arrayData;
                },


                ready: function () {
                    var thisElement = this;
                    this.addEventListener('item-dirty', this._dirtyEventEvaluator);

                    console.log("my-jsoneditor ready");
                }
            });
        })();
    </script>

</dom-module>