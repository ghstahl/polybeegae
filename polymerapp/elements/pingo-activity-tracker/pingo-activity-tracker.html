<link rel="import" href="../pingo-polymer/pingo-polymer.html">

<dom-module id="pingo-activity-tracker">

    <template>
        <iron-ajax id="ironAjaxId" url={{activityCallbackUrl}} on-response="handleResponse" handle-as="json">
        </iron-ajax>
        <mat-toast id="_activityToast" label="This just happened..."></mat-toast>
    </template>

    <script>
        (function () {
            Polymer({

                is: 'pingo-activity-tracker',

                properties: {

                    activityInterval: {
                        type: Number
                    },

                    activityCallbackUrl: {
                        type: String
                    },

                    _dirtyActivity: {
                        type: Boolean
                    }
                },
                _ajaxCallback: function (xhr) {
                    var origin = "//" + window.location.host;
                    var n = xhr.responseURL.indexOf(origin);
                    if (n == -1) {
                        // not ours, so dirty as a call was made to some other domain than ours.
                        this._dirtyActivity = true;
                        // we only set it dirty here, the timer will trigger and make an ajax call to the hosting domain to bump the session.
                    } else {
                        // reset it to clean state.
                        this._dirtyActivity = false;
                    }

                },
                _countDown: function () {
                    if (this._dirtyActivity) {
                        this.$.ironAjaxId.generateRequest();
                    }
                    this._dirtyActivity = false;
                    this.async(this._countDown, this.activityInterval * 1000 * 60)
                },
                handleResponse: function (request) {
                    console.log(" ironAjaxId response recieved");
                    this.$._activityToast.show();
                },
                ready: function () {
                    var self = this;
                    //[\s\S]*
                    PingoPolymer.Utils.AjaxHook.installHook("[\s\S]*", function callback(xhr) {
                        self._ajaxCallback(xhr);
                    });
                    this._dirtyActivity = false;
                    this._countDown(); // initial call.  the rest will be async.
                    console.log("pingo-activity-tracker ready");
                }
            });
        })();
    </script>

</dom-module>